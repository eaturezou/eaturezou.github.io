---
layout: post
author: eature
published: true
categories: Redis
tags:
- redis

Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。

Redis除了做缓存中间件， 还有其他的一些用途， 下面我们来看下。

#### 分布式缓存
最常用也是我们最熟知的就是分布式缓存了， 使用redis的string或者hash或者其他适合的数据结构来存储缓存数据， 因为redis支持持久化数据， 所以redis可以做到宕机数据不完全丢失， 注意是不完全丢失， 如果持久化方式快照的方式来进行数据持久化的话， redis会定期将内存中的数据持久化到文件中去， 这样可以在重启的时候重新从文件中读取数据到内存进行恢复。

#### 分布式锁
这个的使用场景就是处理多个请求对同一个数据进行操作时需要加锁的情况， 例如redis中维护一个账户余额， 购买的时候先读取账户额外， 判断是否充足， 再扣除余额， 那么这个时候就需要用到分布式锁， 在读取和扣除的时候将这个key锁住， 不允许读写， 不然用户完全可以称这个读取和扣除的中间差再购买一遍。

#### 队列
redis的列表结构天然的支持队列， 使用rpush配合lpop或者lpush配合rpop来作为出队入对操作， 像线上一些耗时较大的操作， 比如邮件发送、验证码发送等等， 都可以放到队列中进行异步操作， 尽快的将结果给用户返回， 同时redis提供了阻塞读的操作， brpop。blpop是提供阻塞读的命令， 当队列中没有数据以后， 读取请求会被阻塞， 但是要注意的是， 当长时间没有读取到数据的时候， redis服务端会将这个连接断开， 需要在客户端做好断线重连的异常处理操作。

#### 排行榜
redis的有序集合可以很好的支持排行榜操作， 因为集合的不重复性， 也无需担心重复的问题， 只需要将需要排序的变量为score， 用户为field来存储就可以获得到一个排好序的有序集合， 另外redis提供的zrange能很好的进行切片操作， 也就是能快速的获取到第几到第几范围内的一个排序情况。

#### 节衣缩食的位图
在我的理解来看， 位图就是解决在大范围内的有没有做的问题， 我们知道位只有0和1， 也就是只能是有或者没有， 比如要实时的获取用户每天的商品购买情况， 需要知道这个月或者这年总共购买了多少天的商品等等统计类操作。 当然集合或者有序集合也可以解决这个问题， 但是就是数据量的问题的，内存是个昂贵的硬件。比如一个用户存储一年的数据， 那么需要有1到365需要存储， 也就是需要897个字节， 如果有100个用户， 那么就是897000000字节， 也就是856M左右， 那么如果换成位图的话， 一个用户需要365位， 一百万就是365000000位， 也就是45625000字节， 大概44M， 内存使用缩少了20倍， 并且位图提供的一些统计操作也会比结合来的方便点。

快速的大概去重计数
hyperloglog可以提供不精确的去重计数， 使用pfadd配合pfcount就可以了， 同样对比集合， 集合也提供精确的去重操作， 并且提供了更多的操作，hyperloglog只提供了计算的操作， 而hyperloglog的优势依然是存储空间， 例如统计一个页面的uv， 那么将每个用户id记录下来， 如果有100w， 1000w甚至更多的话， 那么内存根本就扛不住， 所以hyoerloglog就可以很好的解决这种只需要去重计数的实现场景， 但是这个计数是大概的， 会有1%左右的误差， 对于uv这类数据就是一个很好的解决方案了  
同样在pfadd的时候， 如果已经在这个计数集合中， 就会返回0， 否则返回1， 利用这个特性， 可以用于允许一定误差的存在判断， 比如用于判断给用户推荐的商品是否已经在用户的购物车中， 当然购物车的数据量不大， 完全可以用set来实现。   
另外需要注意的是， hyperloglog需要额外的12kb的存储空间来维护这个数据结构， 所以对于需要建大量的hyperloglog的key的场景就不适用了， 比如上面说到的购物车去重， 每个用户12kb的话， 那累加的数量也是很大的。

redis还有其他很广泛的使用， 可能需要工作上需要具体的业务场景的时候会想到。




