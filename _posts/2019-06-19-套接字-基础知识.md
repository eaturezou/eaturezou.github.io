---
layout: post
author: eature
published: true
categories: 网络编程
tags:
- socket
---

最近在看Unix网络编程， 大头书， 内容很经典， 也很专业， 记个笔记， 希望能坚持看完吧  
第一部分讲的内容主要是网络协议相关的东西  
#### 套接字的位置
一开始那肯定是万年不变的OSI七层模型： 包括  
1. 应用层
2. 表示层
3. 会话层
4. 传输层
5. 网络层
6. 数据链路层
7. 物理层  

所谓的套接字就是从顶上三层进入传输层的接口，为什么套接字提供的是从OSI顶上三层进入传输层的接口， 这样设计的理由有两个  
1. 顶上三层处理的是具体的网络应用（如ftp， http）的所有细节， 对通信的细节了解很少， 底下四层对网络应用的了解不多， 却是处理所有的网络传输细节
2. 顶上三层构成所谓的用户进程， 底下四层通常作为操作系统内核的一部分提供

#### TCP和UDP协议

tcp， 传输控制协议， 是一个可靠的网络协议， udp， 用户数据报协议， 是一个不可靠的网络协议  

udp是一个简单的传输协议， 应用进程往udp套接字中写入一个消息， 该消息随后被封装成一个udp数据报， 进而被封装成一个IP数据报， 然后发送到目的地， udp不保证数据报会到底其最终的目的，不保证数据报的先后顺序， 也不保证数据报到达的次数
  
我们常说udp是无连接的， 因为udp的客户端与服务端之前不必存在任何长期的关系  

tcp提供客户端与服务端的连接， tcp客户端应该先与服务端建立连接， 然后传输数据， 最后断开这个连接  

tcp提供了数据传输的可靠性， 当tcp向一个终端发送数据的时候， 需要对端返回一个确认， 如果没有收到确认， 将会自动重传， 并等待更长的时间， 但是tcp也不能说是100%的能将数据传输， tcp的可靠性是说tcp提供了数据的可靠传输和故障的可靠通知  

##### tcp连接的建立和终止
tcp建立连接就是众所周知的三次握手了  
1. 服务端准备好接受外来连接
2. 客户端发起连接， 这将导致客户端发送一个SYN分节
3. 服务端确认客户端的请求， 返回确认分节ACK（SYN+1）并返回一个自己的SYN分节
4. 客户端确认服务器的SYN

> client --SYN--> server  
> server --ACK(SYN+1),SYN--> client  
> client --ACK(SYN+1)--> server 

##### TCP的终止连接
TCP连接终止的过程就是所谓得分四次挥手
1. 应用进程调用close， 称为主动关闭， 该端的TCP发送一个FIN分节。 表示数据发送完毕
2. 接受到FIN分节的执行被动关闭， 这个FIN分节由此TCP确认， FIN的接受意味着接收端的应用进程在相应的连接上已经没有其他的数据可发送
3. 一段时间后， 接收到FIN分节的进程将调用close关闭， 导致他也发送一个FIN分节
4. 接收这个FIN分节的原发送端TCP将确认这个FIN
 
> client --FIN--> server  
> server --ACK(FIN+1)--> client  
> server --FIN--> client  
> client --ACK(FIN+1)--> server  

#### 端口号
任何时候， 多个进程可能存在TCP或UDP、SCTP传输层协议中的任何一种，这3中协议都使用16位证书的端口号来去区分这些进程  
一个TCP连接的套接字对是一个定义该连接的四个端点的四元组，包括  
> 本地IP地址 
> 本地TCP端口号
> 外地IP地址
> 外地TCP端口号

标识每个端点的两个值（IP和端口号）通常称为一个套接字 

#### 套接字编程简介

##### 套接字的地址结构
  大多数套接字函数都需要一个指向套接字地址结构体的指针作为参数， 这些结构的名字均以为sockaddr_开头  
* IPV4套接字地址结构  
ipv4地址套接字结构通常称为网际套接字地址结构， 以sockaddr_in命名， 定义在<netinet/in.h>头文件中  
    ```
    struct in_addr {
        in_addt_t s_addr;
    } 
    
    struct sockaddr_in {
        uint8_t sin_len;
        sa_family_t sin_family;
        in_port_t sin_port;
        struct in_addr sin_addr;
        char sin_zero[9];
    }
    ```
##### 值-参数结果
##### 相关函数
